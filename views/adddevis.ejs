<% include header.ejs %>
<!-- =============================================== -->

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->

  <section class="content-header">
    <h1>
      <%= title %>
      <small>Ajout de devis</small>
    </h1>
    <ol class="breadcrumb">
      <li class=""><a href="/index"><i class="fa fa-dashboard"></i> Home</a></li>
      <li class=""><a href="/devis"><i class="fa fa-dashboard"></i> liste des devis</a></li>
      <li class="active"> Ajout Devis</a></li>
    </ol>
  </section>

  <!-- Main content -->
  <section class="content">

    <!-- Default box -->
    <div class="box">
      <div class="box-header with-border">
        <h3 class="box-title">Nouveau <%= title %></h3>

      </div>
      <div class="box-body">

        <!--
        - Nature du document (Devis)
        - N°
        - Date de création
        - Prix total
        - Fournisseur
        - Numero devis fournisseur
        - Date livraison prevu
        -->

        <form class="grid-form" action="/devis/add" method="post">
            <div class="block">
            <fieldset>
              <legend>Informations sur le Devis</legend>
              <div data-row-span="4">
                <div data-field-span="1">
                  <label for="" class="control-label">Nature :</label>
                  <input type="text" name="nature" required="required" class="form-control" id="" placeholder="" value="<%= devis == null ? "":devis.nature %>">
                </div>
                <div data-field-span="3">
                  <label for="" class="control-label">Numero :</label>
                  <input type="text" name="numero" class="form-control" id="" placeholder="" value="<%= devis == null ? "":devis.numero %>">
                </div>
              </div>
            </fieldset>
            <fieldset>
              <div data-row-span="2">
                <div data-field-span="1">
                  <label for="" class="control-label">Date de création :</label>
                  <input id="datepicker" type="text" name="datecreation" class="form-control" id="" placeholder="" value="<%= devis == null ? "":devis.datecreation %>">
                </div>
                <div data-field-span="1">
                  <label for="" class="control-label">Date de livraison prévue :</label>
                  <input id="datepicker2" type="text" name="datelivraisonprevu" class="form-control" id="" placeholder="" value="<%= devis == null ? "":devis.datelivraisonprevu %>">
                </div>
            </div>
          </fieldset>
          <fieldset>
            <!-- <legend>Informations fournisseur</legend> -->
            <div data-row-span="2">
              <div data-field-span="1">
                <label class="col-sm control-label">Fournisseurs :</label>
                <select id="fournisseur" name="fournisseur" required="required" class="form-control select2">
                    <option value="">Selectionner un fournisseur ...</option>
                    <% for(var i=0; i<fournisseurs.length; i++){%>
                      <option value="<%= fournisseurs[i].raisonsocial + " | " + fournisseurs[i].code %>"><%= fournisseurs[i].raisonsocial %></option>
                    <%}%>
                </select>
              </div>
              <div data-field-span="1">
                <label for="" class="control-label">N° devis fournisseur  :</label>
                <input type="text" name="numerodevisfournisseur" class="form-control" id="" placeholder="" value="<%= devis == null ? "":devis.numerodevisfournisseur %>">
              </div>
            </div>
          </fieldset>


          </div>

        <br>

        <!-- Validate Button -->
          <div class="col-md-12">
            <button id="ok" class="btn btn-sm btn-primary pull-right mymg col-md-12" name="button">Valider</button>
          </div>


        <br>
        <hr>

        <section>
          <div>
            <div class="col-md-5 col-sm-5 col-xs-12 item form-group">
              <label>Code article : </label>
              <div class="">
                <select id="articles" class="select2_single form-control" name="prodinfo" type="text">
                  <option></option>
                  <% for (var i = 0; i < articles.length; i++) {%>
                    <option value="<%= articles[i].code + ' | ' + articles[i].designation + ' | ' + articles[i].prixunite + ' | ' + articles[i].tva %>"><%= articles[i].code %> </option>
                  <%}%>
                </select>
              </div>
            </div>

            <div class="col-md-5 col-sm-5 col-xs-12 item form-group">
                <label>Quantité : </label>
                <input id="qte" type="text" name="qte" value="" placeholder="Quantité">
            </div>
            <br>
            <div class="col-md-2 col-sm-2 col-xs-2 items form-group">
                <button class="alim btn btn-sm btn-primary pull-right mymg col-md-12" type="button" name="button">Ajouter</button>
            </div>
          </div>
        </section>




        <table class="table">
        <thead>
          <tr>
            <th>
              Code article
            </th>
            <th>
              Designation
            </th>
            <th>
              Prix Unitaire
            </th>
            <th>
              Quantite
            </th>
            <th>
              TVA
            </th>
            <th>
              Montant HT
            </th>
            <th>
              Action
            </th>
          </tr>
        </thead>
        <tbody class="objList">


        </tbody>

        </table>
        <section>
          <div>
            <label for="">Montant total : </label>
            <div id="montant_total">

            </div>
          </div>
        </section>




      </div>
              <!-- /.box-body -->

      <!--</div>-->
      <!-- /.box-body -->
      <!-- <div class="box-header with-border">
        <h3 class="box-title">Detail <%= title %></h3>

      </div> -->

      <!-- <div class="col-md">
        <label for="code-art">Code article :</label>
        <input name="code-art" type="text" class="col-sm">
        <label for="designation">Designation article :</label>
        <input name="designation" type="text" class="col-sm">
        <label for="prix-unit">Prix Unitaire :</label>
        <input name="prix-unit" type="text" class="col-sm">
        <label for="quantite">Quantite :</label>
        <input name="quantite" type="text" class="col-sm">
        <label for="montant">Montant :</label>
        <input name="montant" type="text" class="col-sm">


      </div> -->


      <br>
      <hr>
      <!-- <div class="box-body">
        <div id="jsGrid"></div>
      </div> -->


      <!-- <div id="todo-list-example">
        <input
          v-model="newTodoText"
          v-on:keyup.enter="addNewTodo"
          placeholder="Add a todo"
        >
        <ul>
          <li
            is="todo-item"
            v-for="(todo, index) in todos"
            v-bind:key="todo"
            v-bind:title="todo"
            v-on:remove="todos.splice(index, 1)"
          ></li>
        </ul>
      </div> -->





        <div class="box-footer">
            <!-- <div id="valzone" class="">
              <button id="validateOne" class="btn btn-sm btn-primary pull-right mymg" type="button" name="button">OK</button>
            </div> -->

            <div id="subform">
              <button type="submit" class="btn btn-sm btn-primary pull-right mymg"><i class="fa fa-fw fa-save"></i></button>
              <!-- <a href="#" class="btn btn-sm btn-primary pull-right mymg"><i class="fa fa-fw fa-save"></i></a> -->
              <a href="/devis" class="btn btn-sm btn-primary pull-right mymg">Liste des <%= title %></a>
            </div>



        </div>
      <!-- /.box-footer-->
      </form>
    </div>
    <!-- /.box -->

  </section>
  <!-- /.content -->




</div>
<!-- /.content-wrapper -->




<% include footer.ejs %>


<script >
$(document).ready(function(){
  var $btn = document.getElementById("ok");

  $btn.addEventListener("click",function(){
   $(".block").disable();
   console.log("TST click");
  });

  $("#fournisseur").select2({
      placeholder: "Select a state",
      allowClear: true
  });
  var $alim = $('.alim');
  var $objList = $('.objList');
  var $articlesobj = $("#articles");
  var $qteobj = $("#qte");
  var totalarticles = [];
  var totalmontant = 0;

  $alim.on('click', function(){

    var articles = <%- JSON.stringify(articles)%>;

    // console.log($articlesobj.val().split('|')[0]);
    // console.log($articlesobj.val().split('|')[1]);
    // console.log($articlesobj.val().split('|')[2]);
    // console.log($articlesobj.val().split('|')[3]);

    var code = $articlesobj.val().split('|')[0];
    var des = $articlesobj.val().split('|')[1];
    var pu = $articlesobj.val().split('|')[2];
    var tva = $articlesobj.val().split('|')[3];
    var qte = $qteobj.val();


    $objList.append("<tr><td>"+  code +"</td><td>"+ des  +"</td><td>"+  pu  +"</td><td>"+  qte +"</td><td>"+  tva  +"</td><td>" + pu * qte + "</td><td><i class='fa fa-close'></i></td></tr>");
    totalarticles.push({code: code, designation: des, prixunite: pu, qte: qte, tva: tva, montantht: pu * qte});
    //console.log(totalarticles);
    // for(i=0; i< articles.length; i++){
    //
    //   $objList.append("<tr><td>"+  articles[i].code +"</td><td>"+ articles[i].designation  +"</td><td>"+  articles[i].prixunite  +"</td><td>"+  articles[i].qte +"</td><td>"+  articles[i].tva  +"</td><td></td><td><i class='fa fa-close'></i></td></tr>");
    //
    // }
    mt = pu * qte;
    $articlesobj.prop("selectedIndex",0);
    $qteobj.val("");
    addto_total(mt);

    $("#montant_total").text(totalmontant);

  });

  var addto_total = function(o){

    totalmontant = totalmontant + o;
  }

  var minusto_total = function(o){
    totalmontant = totalmontant - o;
  }



  $articlesobj.on('change', function(){
    console.log($articlesobj.val());
  });

  $objList.on('click', 'tr td i', function(){
    var row = [];
    var $tr = $(this).parent().parent().find("td");
    // console.log($tr);
    $tr.each(function(){
      row.push($(this).text());
    })
    // console.log("Valeur Ligne : " + row[5]);
    // console.log("Avant : " + totalmontant);
    // totalmontant = totalmontant - Number(row[5]);
    minusto_total(row[5]);
    // console.log("Après : " + totalmontant);

    $(this).parent().parent().remove();

    $("#montant_total").text(totalmontant);

  });

// var stat = query.fail();
// console.log(stat);

//  console.log($.ajax.data());

  // $("#subform").css("display", "none");

  // $("#validateOne").click(function(){
  //   document.getElementById('valzone').style.display = "none";
  //   document.getElementById('subform').style.display =  "";
  //   console.log(clients);
  //   clients.push({ "Name": "Ramona Benton", "Age": 32, "Country": 3, "Address": "Ap #614-689 Vehicula Street", "Married": false });
  //
  //   $("#jsGrid").jsGrid({
  //
  //       onItemUpdated: function(arg) {
  //       //console.log("row updated");
  //      //  console.log(tab[arg.itemIndex].prodqte);
  //       // $('#message').val(JSON.stringify(tab));
  //       },
  //
  //       onItemDeleted: function(arg) {
  //       //console.log("row deleted");
  //      //  totalqte = totalqte - tab[arg.itemIndex].prodqte;
  //       // tab.splice(arg.itemIndex, 1);
  //       // $('#message').val(JSON.stringify(tab));
  //       },
  //
  //       onItemInserted: function() {
  //       //console.log("row deleted");
  //       // $('#message').val(JSON.stringify(tab));
  //       }
  //   });
  //
  //
  // });


 //  var sousfamille = $('#sousfamille option').clone();
 //  //  $('#sousfamille').empty();
 // $('#famille').change(function() {
 //     var val = $(this).val().split("|")[0];
 //     $('#sousfamille').empty();
 //     sousfamille.filter(function(idx, el) {
 //         return val === 'ALL' || $(el).val().indexOf(val) >= 0;
 //     }).appendTo('#sousfamille');
 // });

});
</script>


<script>
  $(function () {

    // var dt = new Date().toISOString();

    $("#datepicker").val(new Date().toISOString().substring(0,10).split("-").reverse().join("/"));
    //Date picker
    $('#datepicker').datepicker({
      autoclose: true,
      format: 'dd/mm/yyyy'
    });

    $('#datepicker2').datepicker({
      autoclose: true,
      format: 'dd/mm/yyyy'
    });


  });
</script>


<script>
    // var clients = [
    // //     { "code": "Otto Clay", "MontantHT": 25, "Qte": 1, "designation": "Ap #897-1459 Quam Avenue", "Married": false },
    // //     { "Name": "Connor Johnston", "Age": 45, "Country": 2, "Address": "Ap #370-4647 Dis Av.", "Married": true },
    // //     { "Name": "Lacey Hess", "Age": 29, "Country": 3, "Address": "Ap #365-8835 Integer St.", "Married": false },
    // //     { "Name": "Timothy Henson", "Age": 56, "Country": 1, "Address": "911-5143 Luctus Ave", "Married": true },
    // //     { "Name": "Ramona Benton", "Age": 32, "Country": 3, "Address": "Ap #614-689 Vehicula Street", "Married": false }
    // ];
    //

    // var query = $.ajax({
    //         type: "GET",
    //         url: "/articles/api-get",
    //         dataType: "json"
    //         });
    //


//   query.success(function(msg){
//     //  console.log("msg | "+ msg);
//      articles = msg;
//     //  console.log("clients | " + clients);
//     //  for(i=0; i<clients.length; i++){
//     //    console.log(clients[i]);
//     //  }
//
//     // var countries = [
//     //     { Name: "", Id: 0 },
//     //     { Name: "United States", Id: 1 },
//     //     { Name: "Canada", Id: 2 },
//     //     { Name: "United Kingdom", Id: 3 }
//     // ];
//
//     $("#jsGrid").jsGrid({
//         width: "100%",
//         height: "400px",
//
//         inserting: true,
//         editing: true,
//         sorting: true,
//         paging: true,
//
//         data: clients,
//
//         fields: [
//             { name: "code", type: "select", items: articles, valueField: "code", textField: "code", width: 50, validate: "required" },
//             { name: "designation", type: "text", width: 100 },
//             { name: "prixunite", type: "text", width: 20 },
//             { name: "Qte", type: "text", width: 20 },
//             { name: "MontantHT", type: "text", width: 50 },
//             { name: "tva", type: "number", width: 20 },
//             { name: "total_TVA", type: "text", width: 20 },
//             { name: "total_TTC", type: "text", width: 20 },
//             { type: "control" }
//         ]
//     });
// });
</script>


<!-- <script type="text/javascript">

    Vue.component('todo-item', {
    template: `
      <li>
        <div class="col-md-5">
          {{ title }}
        </div>
          <div class="col-md-5">
            <button class="btn btn-xs btn-danger" v-on:click="$emit('remove')"><i class='fa fa-close'></i></button>
          </div>

      </li>
    `,
    props: ['title']
    })

    new Vue({
    el: '#todo-list-example',
    data: {
      newTodoText: '',
      todos: [
        'Do the dishes',
        'Take out the trash',
        'Mow the lawn'
      ]
    },
    methods: {
      addNewTodo: function () {
        this.todos.push(this.newTodoText)
        this.newTodoText = ''
      }
    }
    })
</script> -->
